<div [class]="themeClass">
  <mat-toolbar fxLayout="row" color="primary" style="background-color: #002c85;"class="mat-elevation-z4">  
    <mat-toolbar-row>
      <div fxLayout="row" fxLayoutGap="0.5em" fxLayoutAlign="start center">
        <img src="../assets/topbar_logo.png" width="50px" height="50px" alt="XRP Ledger Services Logo">
        <label style="font-weight: bold;">{{title}}</label>  
      </div>
    </mat-toolbar-row>
  </mat-toolbar>

  <mat-card class="mat-card-red" *ngIf="errorLabel" fxLayout="column" fxLayoutGap="0.5em">
    <label>Sorry that this error happened! Please copy the following error and send it to @XrplServices on twitter or via mail to: info@xrpl.services . Thanks for your help!</label>
    <label>&nbsp;</label>
    <label class="break-words" (click)="copyError()">{{errorLabel}}</label>
    <button mat-button class="xumm-grey-background" aria-label="Copy Error" (click)="copyError()">
      Copy&nbsp;<mat-icon style="font-size: 16px; width: fit-content; height: fit-content;">content_copy</mat-icon>
    </button>
  </mat-card>

  <mat-card class="mat-card-orange floatcenter" *ngIf="loadingData && !xrplAccountInfo" fxLayout="row" fxLayoutGap="0.5em" style="margin: 0.5em">
    <label>Loading your TrustLines...</label>
    <mat-progress-spinner color="primary" mode="indeterminate" diameter=25></mat-progress-spinner>
  </mat-card>

  <mat-card class="mat-card-red" *ngIf="!loadingData && (!xrplAccountInfo || !xrplAccountInfo.Account)" fxLayout="column" fxLayoutGap="0.5em">
    <label>You opened the xApp with an account you don't have full access to. (Read only)</label>
    <label>&nbsp;</label>
    <label>Please close this xApp, navigate to the home screen and switch to the account you want to issue your token from. (Needs to have 'Full Access') Then open the xApp again.</label>
  </mat-card>

  <!--label *ngIf="infoLabel" style="color: red">{{infoLabel}}</label><br><br>
  <label *ngIf="infoLabel2" style="color: red">{{infoLabel2}}</label>
  <label *ngIf="infoLabel3" style="color: red">{{infoLabel3}}</label-->

  <mat-stepper orientation="horizontal" [linear]="isLinear" #stepper class="theme-background" *ngIf="xrplAccountInfo && xrplAccountInfo.Account">
    <mat-step completed="false" editable="false">
        <mat-card class="stepcontainer" fxLayout="column" fxLayoutGap="0.5em" style="margin-left: 0.5em; margin-right: 0.5em;">
          <h2>Select a Token to get rid of:</h2>
            <div *ngIf="simpleTrustlines" fxLayout="column" fxLayoutGap="0.3em">

              <mat-card fxLayout="row" style="padding-top: 1em;" fxLayoutAlign="start center" fxLayoutGap="1em">
                <label><b>Filter:</b></label>
                <mat-form-field>
                  <mat-label class="loading">
                    <i class="material-icons">
                      search
                    </i>
                  </mat-label>
                  <input matInput [disabled]="loading" [(ngModel)]="searchString" (keyup)="applyFilter()" placeholder="Search for Token ...">
                </mat-form-field>
              </mat-card>
              
              <div>
                <div class="listarea" *ngIf="simpleTrustlines.length > 0">
                  <ul class="list" fxLayout="column" fxLayoutGap="1em">
                    <li *ngFor="let trustline of simpleTrustlines" fxLayout="row" fxLayoutAlign="center center" fxLayoutGap="0.5em">
                      <div style="font-size: medium;" fxLayoutAlign="center center">
                        <b><code>{{trustline.currencyShow}}: {{trustline.balanceShow}}</code></b>
                      </div>
                      <span style="flex: 1 1 auto;"></span>
                      <div fxLayout="row" fxLayoutAlign="center center">
                        <button mat-raised-button class="thin" color="primary" (click)="selectToken(trustline)">Remove</button>
                      </div>
                    </li>
                  </ul>
                </div>
                <div *ngIf="simpleTrustlines.length <= 0">
                  <mat-card class="mat-card-orange floatcenter">
                    <label>No Tokens found</label>
                  </mat-card>
                </div>
              </div>
            </div>
        </mat-card>
    </mat-step>

    <mat-step completed="false" editable="false">
      <mat-card class="stepcontainer" fxLayout="column" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="margin-left: 0.5em; margin-right: 0.5em;">

        <mat-card class="mat-card-red" fxLayout="column" fxLayoutAlign="center center" style="width: 100%;">
          <label><b>You have {{selectedToken && selectedToken.balanceShow}} {{selectedToken && selectedToken.currencyShow}} left!</b></label>
        </mat-card>

        <div *ngIf="canConvert && !convertionStarted && !loadingData" fxLayout="column" fxLayoutGap="1em" fxLayoutAlign="start center" style="width: 100%;">
          <mat-card class="mat-card-orange" fxLayout="column" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="width: 100%;">
            <label>You can convert some of your {{selectedToken && selectedToken.currencyShow}} into XRP.</label>
            <label>The XRP Ledger will try to convert as much of your Token into XRP as possible to the best available rate.</label>
            <label>&nbsp;</label>
            <label>&nbsp;</label>
            <label>We will set a very low XRP value to exchange for (1 Drop or 0.000001 XRP). But don't worry, the XRP Ledger will give you always the best available rate and you will receive more XRP than shown.</label>
          </mat-card >
          <button mat-raised-button class="btn" color="primary" (click)="convertTokenIntoXrp()">Convert to XRP</button>
        </div>

        <div *ngIf="selectedToken && canConvert && convertionStarted && !loadingData" style="width: 100%;" fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="0.5em">

          <mat-card class="mat-card-green" *ngIf="canConvert && convertionStarted && convertedXrp > 0" fxLayout="column" fxLayoutGap="0.5em" style="width: 100%;">
            <label>You have successfully exchanged some of your token for {{convertedXrp}} XRP.</label>
            <div *ngIf="selectedToken && selectedToken.balance > 0">
              <label>The rest can not be exchanged and we will send it back to the issuer to get rid of it!</label>
              <label>After that, we can remove the trustline!</label>
            </div>
          </mat-card>
        </div>

        <div *ngIf="selectedToken && selectedToken.balance > 0  && (!canConvert || (canConvert && convertionStarted)) && !loadingData" style="width: 100%;" fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="0.5em">
          <mat-card class="mat-card-orange" *ngIf="!canConvert" fxLayout="column" fxLayoutAlign="center center" style="width: 100%;">
            <label>Unfortunately, this token can not be converted into XRP.</label>
            <label>We have to send it back to the issuer to get rid of it!</label>
            <label>After that, we can remove the trustline!</label>
          </mat-card>
        </div>

        

        <div *ngIf="selectedToken && selectedToken.balance > 0 && (!canConvert || (canConvert && convertionStarted)) && !loadingData" fxLayout="column" fxLayoutGap="0.5em" style="width: 100%; padding-top: 2em;">
          <mat-checkbox [(ngModel)]="checkboxSendToIssuer" [ngClass]="(checkboxSendToIssuer ? 'xumm-green': 'xumm-red')">Sending the token back to the issuer means to lose ALL ACCESS to this token. It won't be converted to XRP AND you won't be able to get the token back. Please confirm to send back {{selectedToken && selectedToken.balanceShow}} {{selectedToken && selectedToken.currencyShow}} to the issuer!</mat-checkbox>

          <button mat-raised-button style="width: 100%;" class="btn" color="primary" [disabled]="!checkboxSendToIssuer" (click)="sendToIssuer()">Send to Issuer</button>
        </div>

        <div *ngIf="selectedToken && selectedToken.balance === 0 && !loadingData" style="width: 100%" fxLayout="column" fxLayoutAlign="start center">
          <mat-card class="mat-card-green" fxLayout="row" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="width: 100%">
            <i class="material-icons xumm-green" style="font-size: 3em;">
                check_circle_outline
            </i>
            <div fxLayout="column" fxLayoutGap="0.3em">
              <label>Your Token balance is now 0.</label>
              <label>We can now remove the trustline!</label>
            </div>
          </mat-card>
        </div>

        <div *ngIf="loadingData" fxLayout="column" fxLayoutAlign="center center" style="width: 100%">
          <mat-card class="mat-card-orange" fxLayout="row" fxLayoutGap="0.5em" fxLayoutAlign="center center" style="width: 100%">
            <label>Loading...</label>
            <mat-progress-spinner color="primary" mode="indeterminate" diameter=25></mat-progress-spinner>
          </mat-card>
        </div>

        <div fxLayoutGap="0.5em" style="width: 100%;" fxLayout="column" fxLayoutGap="0.5em">
          <div *ngIf="selectedToken && selectedToken.balance == 0">
            <button mat-raised-button style="width: 100%;" color="primary" (click)="moveNext()" [disabled]="(selectedToken && selectedToken.balance != 0 ) || loadingData">Next</button>
          </div>  
          <button mat-raised-button style="width: 100%;" class="xumm-grey-background" (click)="moveBack()" [disabled]="loadingData">Back</button>
        </div>
      </mat-card>
    </mat-step>

    <mat-step completed="false" editable="false">
      <mat-card fxLayout="column" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="margin-left: 0.5em;margin-right: 0.5em;">
        <div *ngIf="!tokenHasBeenRemoved() && !loadingData" fxLayout="column" fxLayoutGap="1em" fxLayoutAlign="start center" style="width: 100%;">
          <mat-card class="mat-card-orange">
            <label>The final step is to remove the trustline. So lets go ahead!</label>
          </mat-card>
          <button mat-raised-button style="width: 100%;" color="primary" (click)="removeTrustLine()">Remove Trustline</button>
          <div style="padding-top: 0.5em; width: 100%" fxLayoutGap="0.5em">
              <button mat-raised-button style="width: 100%;" class="xumm-grey-background" (click)="moveBack()">Back</button>
          </div>
        </div>

        <div *ngIf="tokenHasBeenRemoved() && !loadingData" fxLayout="column" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="width: 100%;">
          <mat-card class="mat-card-green" fxLayout="row" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="width: 100%;">
            <i class="material-icons xumm-green" style="font-size: 3em;">
                check_circle_outline
            </i>
            <label>The token {{selectedToken && selectedToken.currencyShow}} has been removed.</label>
          </mat-card>
          <mat-card class="mat-card-green" fxLayout="column" fxLayoutGap="0.5em" fxLayoutAlign="start center" style="width: 100%;">
            <label>Your account gained 2 XRP from removing the trustline</label>
            <label *ngIf="convertedXrp && convertedXrp > 0">You also gained {{convertedXrp}} XRP from converting the token into XRP</label>
          </mat-card>

          <div *ngIf="(convertedXrp && convertedXrp > 1) || showDonation()" style="width: 100%;">
            <mat-card class="mat-card-green" style="width: 100%;">
              <label *ngIf="convertedXrp && convertedXrp > 1">You gained a total of {{convertedXrp + 2}}.</label>
              <label>Please consider a donation for using this free of charge service. Thank you!</label>
            </mat-card>
            <button mat-raised-button color="primary" (click)="makeDonation()">Make a donation</button>
          </div>
          <div style="padding-top: 0.5em; width: 100%" fxLayout="column" fxLayoutGap="1em">
            <button mat-raised-button style="width: 100%;" color="primary" (click)="trashAnotherOne()">Remove another one!</button>
            <button mat-raised-button style="width: 100%;" class="xumm-grey-background" (click)="close()">Close xApp</button>
          </div>
        </div>

        <div *ngIf="loadingData" fxLayout="column" fxLayoutAlign="center center" style="width: 100%">
          <mat-card class="mat-card-orange" fxLayout="row" fxLayoutGap="0.5em" fxLayoutAlign="center center" style="width: 100%">
            <label>Loading...</label>
            <mat-progress-spinner color="primary" mode="indeterminate" diameter=25></mat-progress-spinner>
          </mat-card>
        </div>
      </mat-card>
    </mat-step>
  </mat-stepper>
</div>